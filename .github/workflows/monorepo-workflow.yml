name: Monorepo CI/CD

on:
  push:
    branches:
      - main


jobs:

  trufflehog-scan:
    name: TruffleHog Enterprise scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Fetch all history so multiple commits can be scanned
      - name: TruffleHog Enterprise scan
        uses: trufflesecurity/TruffleHog-Enterprise-Github-Action@main
        with:
          args: --fail-verified ${{ github.event.repository.default_branch }} HEAD

  debug-job:
    name: Debug Job
    runs-on: ubuntu-latest
    needs: trufflehog-scan
    steps:
      - name: Print Event Payload
        env:
          GITHUB_EVENT: ${{ toJson(github.event) }}
        run: echo "GITHUB_EVENT=$GITHUB_EVENT"
      - name: Print Commits
        run: |
          echo "Printing commit information..."
          echo "${{ toJson(github.event.commits) }}"
      - name: Print Added Files
        run: |
          echo "Printing added files..."
          echo "${{ toJson(github.event.commits.*.added) }}"
      - name: Print Modified Files
        run: |
          echo "Printing modified files..."
          echo "${{ toJson(github.event.commits.*.modified) }}"
      - name: Print Removed Files
        run: |
          echo "Printing removed files..."
          echo "${{ toJson(github.event.commits.*.removed) }}"

  cdk-job:
    name: cdk CI/CD
    runs-on: ubuntu-latest
    needs: trufflehog-scan
    if: ${{ success() && (contains(github.event.commits.*.added, 'FamilyVaultCdk/') || contains(github.event.commits.*.modified, 'FamilyVaultCdk/') || contains(github.event.commits.*.removed, 'FamilyVaultCdk/')) }}
    steps:
      - name: Call cdk API Gateway
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: token ${{ secrets.AUTHORIZATION_KEY }}" \
            -d '{"action": "trigger"}' \
            ${{ secrets.APIGATEWAY_WEBHOOK_URL }}/cdk
  cicd-job:
    name: CICD CI/CD
    runs-on: ubuntu-latest
    needs: trufflehog-scan
    if: ${{ success() && (contains(github.event.commits.*.added, 'FamilyVaultCicd/') || contains(github.event.commits.*.modified, 'FamilyVaultCicd/') || contains(github.event.commits.*.removed, 'FamilyVaultCicd/')) }}
    steps:
      - name: Call CICD API Gateway
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: token ${{ secrets.AUTHORIZATION_KEY }}" \
            -d '{"action": "trigger"}' \
            ${{ secrets.APIGATEWAY_WEBHOOK_URL }}/cicd

  react-job:
    name: React CI/CD
    runs-on: ubuntu-latest
    needs: trufflehog-scan
    if: ${{ success() && (contains(github.event.commits.*.added, 'FamilyVaultReact/') || contains(github.event.commits.*.modified, 'FamilyVaultReact/') || contains(github.event.commits.*.removed, 'FamilyVaultReact/')) }}
    steps:
      - name: Call React API Gateway
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: ${{ secrets.AUTHORIZATION_KEY }}" \
            -d '{"action": "trigger"}' \
            ${{ secrets.APIGATEWAY_WEBHOOK_URL }}/react

